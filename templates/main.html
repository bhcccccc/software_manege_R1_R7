<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·æ´‹ç‰§åœºç›‘æµ‹ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ ECharts -->
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/china.js') }}"></script>
    <style>
        body {
            margin: 0;
            font-family: "Microsoft YaHei", sans-serif;
            background-color: var(--light-gray);
            color: var(--dark);
        }

        /* å¯¼èˆªæ æ ·å¼ - åŒ¹é…ç¬¬äºŒä¸ªHTMLçš„æ ·å¼ */
        .navbar {
            background-color: #003366;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 {
            color: #fff;
            font-size: 20px;
            margin: 0;
        }
        .navbar ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar ul li {
            margin: 0 15px;
        }
        .navbar ul li a {
            color: #fff;
            text-decoration: none;
        }
        .navbar .username,
        .exit {
            margin-left: 20px;
        }

        :root {
            --primary-blue: #003366;
            --secondary-blue: #0066cc;
            --light-blue: #f0f8ff;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --white: #ffffff;
            --dark: #333333;
            --light-gray: #f5f5f5;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-container {
            max-width: 1980px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background-color: var(--primary-blue);
            color: var(--white);
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 12px 20px;
            font-weight: 500;
        }

        .card-body {
            padding: 20px;
        }

        /* è§†é¢‘å®¹å™¨ */
        .video-container {
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* æŠ¥è­¦æ¨¡å— */
        .alarm-container {
            height: 100%;
        }

        #alarm-display {
            height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .alarm-message {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: var(--light-gray);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .alarm-message:hover {
            transform: translateX(4px);
        }

        .alarm-message.critical {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger);
        }

        .alarm-message.warning {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
        }

        .alarm-message.info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--secondary-blue);
        }

        .alarm-icon {
            font-size: 1.1rem;
            margin-top: 2px;
        }

        .critical .alarm-icon {
            color: var(--danger);
        }

        .warning .alarm-icon {
            color: var(--warning);
        }

        .info .alarm-icon {
            color: var(--secondary-blue);
        }

        .alarm-content {
            flex: 1;
        }

        .alarm-time {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 4px;
        }

        .alarm-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* åœ°å›¾å®¹å™¨ - è°ƒæ•´å®½åº¦ */
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        /* é˜ˆå€¼è®¾ç½®è¡¨å• - è°ƒæ•´ä¸ºä¸¤åˆ—å¸ƒå±€ */
        .threshold-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        /* ä¿å­˜æŒ‰é’®æ ·å¼ */
        .threshold-form button {
            grid-column: 1 / -1;
            padding: 12px;
            font-size: 1.1rem;
            margin: 10px auto;
            display: block;
            width: 80%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .threshold-form {
                grid-template-columns: 1fr;
            }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  - åŒ¹é…ç¬¬äºŒä¸ªHTMLçš„æ ·å¼ -->
    <div class="navbar">
        <div><h1>æµ·æ´‹ç‰§åœºç›‘æµ‹ç³»ç»Ÿ</h1></div>
        <ul>
            <li><a href="{{ url_for('tomain') }}"><i class="home-icon"></i> é¦–é¡µ</a></li>
            <li><a href="{{ url_for('todata') }}"><i class="data-icon"></i> ä¸»è¦ä¿¡æ¯</a></li>
            <li><a href="{{ url_for('towater') }}"><i class="underwater-icon"></i> æ°´ä¸‹ç³»ç»Ÿ</a></li>
            <li><a href="{{ url_for('toai') }}"><i class="ai-icon"></i> æ™ºèƒ½ä¸­å¿ƒ</a></li>
            {% if userrole=="admin" %}
            <li><a href="{{ url_for('toadadmin') }}"><i class="admin-icon"></i> ç®¡ç†å‘˜</a></li>
            {% endif %}
        </ul>
        <div>
            <ul>
                <li><a href="{{ url_for('topersonal') }}" class="username"><i class="user-icon"></i> {{ username }}</a></li>
                <li><a href="{{ url_for('exit') }}" class="exit"><i class="exit-icon"></i> é€€å‡º</a></li>
            </ul>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <div class="row g-4">
            <!-- ç¬¬ä¸€è¡Œï¼šè§†é¢‘å’ŒæŠ¥è­¦æ¨¡å— -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-video me-2"></i>å®æ—¶ç›‘æ§è§†é¢‘
                    </div>
                    <div class="card-body">
                        <div class="video-container">
                            <video autoplay loop muted controls>
                                <source src="../static/video/yu1.mp4" type="video/mp4">
                                æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå†…åµŒè§†é¢‘ã€‚
                            </video>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card alarm-container">
                    <div class="card-header">
                        <i class="fas fa-bell me-2"></i>æ°´è´¨æŠ¥è­¦ä¿¡æ¯
                    </div>
                    <div class="card-body">
                        <div id="alarm-display">
                            <div class="empty-state">
                                <i class="fas fa-bell-slash"></i>
                                <p>æš‚æ— æŠ¥è­¦ä¿¡æ¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šåœ°å›¾å’Œé˜ˆå€¼è®¾ç½® -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map-marked-alt me-2"></i>å…¨å›½å®æ—¶æ°”æ¸©åˆ†å¸ƒå›¾
                    </div>
                    <div class="card-body">
                        <div class="map-container" id="main"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sliders-h me-2"></i>æ°´è´¨æŠ¥è­¦é˜ˆå€¼è®¾ç½®
                    </div>
                    <div class="card-body">
                        <form id="threshold-form" class="threshold-form">
                            <div class="mb-3">
                                <label for="water_temp" class="form-label"><i class="fas fa-temperature-high me-2"></i>æ°´æ¸© (Â°C)</label>
                                <input type="number" class="form-control" id="water_temp" step="0.1" placeholder="ä¾‹å¦‚ï¼š18" required>
                            </div>
                            <div class="mb-3">
                                <label for="dissolved_oxy" class="form-label"><i class="fas fa-lungs me-2"></i>æº¶è§£æ°§ (mg/L)</label>
                                <input type="number" class="form-control" id="dissolved_oxy" step="0.1" placeholder="ä¾‹å¦‚ï¼š7" required>
                            </div>
                            <div class="mb-3">
                                <label for="conductivity" class="form-label"><i class="fas fa-bolt me-2"></i>ç”µå¯¼ç‡ (Î¼S/cm)</label>
                                <input type="number" class="form-control" id="conductivity" step="1" placeholder="ä¾‹å¦‚ï¼š900" required>
                            </div>
                            <div class="mb-3">
                                <label for="turbidity" class="form-label"><i class="fas fa-water me-2"></i>æµŠåº¦ (NTU)</label>
                                <input type="number" class="form-control" id="turbidity" step="0.1" placeholder="ä¾‹å¦‚ï¼š200" required>
                            </div>
                            <div class="mb-3">
                                <label for="permanganate_index" class="form-label"><i class="fas fa-flask me-2"></i>é«˜é”°é…¸ç›æŒ‡æ•°</label>
                                <input type="number" class="form-control" id="permanganate_index" step="0.1" placeholder="ä¾‹å¦‚ï¼š6" required>
                            </div>
                            <div class="mb-3">
                                <label for="ammonia_nitrogen" class="form-label"><i class="fas fa-atom me-2"></i>æ°¨æ°® (mg/L)</label>
                                <input type="number" class="form-control" id="ammonia_nitrogen" step="0.1" placeholder="ä¾‹å¦‚ï¼š0.5" required>
                            </div>
                            <div class="mb-3">
                                <label for="total_phosphorus" class="form-label"><i class="fas fa-atom me-2"></i>æ€»ç£· (mg/L)</label>
                                <input type="number" class="form-control" id="total_phosphorus" step="0.1" placeholder="ä¾‹å¦‚ï¼š0.2" required>
                            </div>
                            <div class="mb-3">
                                <label for="total_nitrogen" class="form-label"><i class="fas fa-atom me-2"></i>æ€»æ°® (mg/L)</label>
                                <input type="number" class="form-control" id="total_nitrogen" step="0.1" placeholder="ä¾‹å¦‚ï¼š3.5" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>ä¿å­˜è®¾ç½®
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥ Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.3/socket.io.min.js"></script>
    
    <script>
        // åˆå§‹åŒ–å›¾è¡¨
        let myEcharts = echarts.init(document.getElementById("main"));
    
        // åŸå¸‚åˆ—è¡¨
        const cities = [
            'Beijing', 'Shanghai', 'Tianjin', 'Chongqing',
            'Shijiazhuang', 'Taiyuan', 'Hohhot', 'Shenyang', 'Changchun',
            'Harbin', 'Nanjing', 'Hangzhou', 'Hefei', 'Fuzhou', 'Nanchang',
            'Jinan', 'Zhengzhou', 'Wuhan', 'Changsha', 'Guangzhou', 'Nanning',
            'Haikou', 'Chengdu', 'Guiyang', 'Kunming', 'Lhasa', 'Xian',
            'Lanzhou', 'Xining', 'Yinchuan', 'Urumqi'
        ];
    
        // åŸå¸‚å -> ä¸­æ–‡çœä»½å æ˜ å°„è¡¨
        const cityMap = {
            "Beijing": "åŒ—äº¬", "Shanghai": "ä¸Šæµ·", "Tianjin": "å¤©æ´¥", "Chongqing": "é‡åº†",
            "Shijiazhuang": "æ²³åŒ—", "Taiyuan": "å±±è¥¿", "Hohhot": "å†…è’™å¤", "Shenyang": "è¾½å®",
            "Changchun": "å‰æ—", "Harbin": "é»‘é¾™æ±Ÿ", "Nanjing": "æ±Ÿè‹", "Hangzhou": "æµ™æ±Ÿ",
            "Hefei": "å®‰å¾½", "Fuzhou": "ç¦å»º", "Nanchang": "æ±Ÿè¥¿", "Jinan": "å±±ä¸œ",
            "Zhengzhou": "æ²³å—", "Wuhan": "æ¹–åŒ—", "Changsha": "æ¹–å—", "Guangzhou": "å¹¿ä¸œ",
            "Nanning": "å¹¿è¥¿", "Haikou": "æµ·å—", "Chengdu": "å››å·", "Guiyang": "è´µå·",
            "Kunming": "äº‘å—", "Lhasa": "è¥¿è—", "Xian": "é™•è¥¿", "Lanzhou": "ç”˜è‚ƒ",
            "Xining": "é’æµ·", "Yinchuan": "å®å¤", "Urumqi": "æ–°ç–†"
        };
    
        // å­˜å‚¨åŸå¸‚æ¸©åº¦æ•°æ®
        let weatherData = [];
    
        // è·å–å¤©æ°”æ•°æ®
        async function fetchWeather(cityName, apiKey) {
            const url = `https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${apiKey}&units=metric`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                return { name: cityMap[cityName], value: Math.round(data.main.temp) };
            } catch (e) {
                console.error(`æ— æ³•è·å– ${cityName} å¤©æ°”`);
                return null;
            }
        }
    
        // åŠ è½½å¹¶æ¸²æŸ“åœ°å›¾
        async function loadAndRender() {
            const apiKey = '7232a656fbb648e1c7336093960499fa';
            const promises = cities.map(city => fetchWeather(city, apiKey));
            const results = await Promise.all(promises);
            weatherData = results.filter(item => item !== null);
    
            let option = {
                title: {
                    x: "center",
                    textStyle: { fontSize: 18, color: "#0066cc" }
                },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: "rgba(0, 102, 204, 0.9)",
                    textStyle: { color: "#fff" },
                    formatter: 'åœ°åŒºï¼š{b}<br/>æ°”æ¸©ï¼š{c}Â°C',
                    extraCssText: 'width:120px;height:60px;border-radius: 5px;'
                },
                visualMap: {
                    top: 'center',
                    left: 'left',
                    min: -10,
                    max: 40,
                    text: ['é«˜æ¸©', 'ä½æ¸©'],
                    textStyle: { color: "#333" },
                    realtime: false,
                    calculable: true,
                    inRange: {
                        color: ['#87CEFA', '#FFD700', '#FF4500']
                    }
                },
                series: [{
                    name: 'å®æ—¶æ°”æ¸©',
                    type: 'map',
                    mapType: 'china',
                    roam: false,
                    center: ['50%','50%'],
                    itemStyle: {
                        normal: {
                            borderColor: 'rgba(0, 0, 0, 0.2)',
                            areaColor: '#E0E0E0',
                            label: {
                                show: true,
                                textStyle: { color: '#333' }
                            }
                        },
                        emphasis: {
                            areaColor: '#0066cc',
                            label: { show: true }
                        }
                    },
                    data: weatherData
                }]
            };
    
            myEcharts.setOption(option);
        }
    
        // æ‰§è¡ŒåŠ è½½
        loadAndRender();
    
        // è‡ªé€‚åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            myEcharts.resize();
        });

        // æŠ¥è­¦æ¨¡å—åŠŸèƒ½
        const socket = io('http://127.0.0.1:3000');
        let emptyState = document.querySelector('.empty-state');

        // è¡¨å•æäº¤
        document.getElementById('threshold-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = {
                water_temperature: parseFloat(document.getElementById('water_temp').value),
                dissolved_oxygen: parseFloat(document.getElementById('dissolved_oxy').value),
                conductivity: parseFloat(document.getElementById('conductivity').value),
                turbidity: parseFloat(document.getElementById('turbidity').value),
                permanganate_index: parseFloat(document.getElementById('permanganate_index').value),
                ammonia_nitrogen: parseFloat(document.getElementById('ammonia_nitrogen').value),
                total_phosphorus: parseFloat(document.getElementById('total_phosphorus').value),
                total_nitrogen: parseFloat(document.getElementById('total_nitrogen').value)
            };

            // éªŒè¯æ•°æ®
            for (const key in formData) {
                if (isNaN(formData[key])) {
                    showAlert('è¯·å¡«å†™æ‰€æœ‰æœ‰æ•ˆçš„é˜ˆå€¼ï¼', 'warning');
                    return;
                }
            }

            socket.emit('set_alarm_thresholds', formData);
            showAlert('é˜ˆå€¼è®¾ç½®å·²ä¿å­˜ï¼', 'success');
        });

        // æ¥æ”¶æŠ¥è­¦ä¿¡æ¯
        socket.on('new_alarm', function(data) {
            const alarmDisplay = document.getElementById('alarm-display');
            
            // ç§»é™¤ç©ºçŠ¶æ€æç¤º
            if (emptyState) {
                alarmDisplay.removeChild(emptyState);
                emptyState = null;
            }

            // åˆ›å»ºæŠ¥è­¦æ¶ˆæ¯å…ƒç´ 
            const alarmMessage = document.createElement('div');
            alarmMessage.className = `alarm-message ${data.severity || 'critical'}`;
            
            // æ ¹æ®ä¸¥é‡ç¨‹åº¦é€‰æ‹©å›¾æ ‡
            let iconClass;
            if (data.severity === 'warning') {
                iconClass = 'fa-exclamation-triangle';
            } else if (data.severity === 'info') {
                iconClass = 'fa-info-circle';
            } else {
                iconClass = 'fa-exclamation-circle';
            }

            alarmMessage.innerHTML = `
                <div class="alarm-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="alarm-content">
                    <div class="alarm-time">${new Date().toLocaleString()}</div>
                    <div class="alarm-text">${data.message}</div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢é¡¶éƒ¨
            alarmDisplay.insertBefore(alarmMessage, alarmDisplay.firstChild);
            
            // æµè§ˆå™¨é€šçŸ¥
            triggerBrowserNotification(data.message, data.severity);
        });

        // æµè§ˆå™¨é€šçŸ¥
        function triggerBrowserNotification(message, severity) {
            let notificationTitle = 'æ°´è´¨æŠ¥è­¦';
            let notificationOptions = {
                body: message,
                icon: '/favicon.ico'
            };

            if (severity === 'warning') {
                notificationTitle = 'âš ï¸ æ°´è´¨è­¦å‘Š';
            } else if (severity === 'critical') {
                notificationTitle = 'ğŸš¨ æ°´è´¨ä¸¥é‡æŠ¥è­¦';
            }

            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(notificationTitle, notificationOptions);
                    }
                });
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.textAlign = 'center';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.add('fade');
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 300);
            }, 3000);
        }

        // åˆå§‹åŒ–åŠ è½½æ—¶è¯·æ±‚å½“å‰é˜ˆå€¼
        socket.emit('request_current_thresholds');
        
        socket.on('current_thresholds', function(data) {
            if (data) {
                document.getElementById('water_temp').value = data.water_temperature || '';
                document.getElementById('dissolved_oxy').value = data.dissolved_oxygen || '';
                document.getElementById('conductivity').value = data.conductivity || '';
                document.getElementById('turbidity').value = data.turbidity || '';
                document.getElementById('permanganate_index').value = data.permanganate_index || '';
                document.getElementById('ammonia_nitrogen').value = data.ammonia_nitrogen || '';
                document.getElementById('total_phosphorus').value = data.total_phosphorus || '';
                document.getElementById('total_nitrogen').value = data.total_nitrogen || '';
            }
        });
    </script>
</body>
</html>